#!/bin/bash

# Create archive from source files

set -e

EXCL='--exclude="*~" --exclude=".??*" --exclude="#*" --exclude=debug'

# command line arg = e.g. archive/ncbi-20170425 source/ncbi-20170425 

name=$1

dryrun=
if [ x$DRYRUN != x ]; then dryrun=echo; fi

# For URL: strip off the version number, leaving only the resource name

stem=`echo $name | egrep -o "^[^0-9]+"`
# Index of last char in stem
i=$((${#stem}-1))
if [ ${stem:$i} = '-' ]; then
    stem=${stem:0:$i}
elif [ ${stem:$i} = '.' ]; then
    stem=${stem:0:$i}
fi
if [ ! -e suffix/$stem ]; then
    echo "Missing suffix file suffix/$stem (see bin/update_config.py)"
    exit 1
fi
suffix=`cat suffix/$stem`

if [ $suffix = '.zip' ]; then
    echo "Zip archiving not implemented"
    exit 1
elif [ $suffix = '-ot.tgz' ]; then
    if [ `dirname $dir` = source ]; then
        dir=resource/$name
    fi
elif [ $suffix != '.tgz' ]; then
    echo "pack-archive: Unrecognized suffix $suffix"
    exit 1
fi

if [ $suffix = 'zip' ]; then
    echo ".zip creation NYI - $name"
    exit 1
elif [ $suffix = '-ot.tgz' ]; then
    src=r/$name/resource
elif [ $suffix = '.tgz' ]; then
    src=r/$name/source
fi

if [ ! -e $src/.made ]; then
    echo "Missing sources (need $src/.made)"
    exit 1
fi

dest=r/$name/archive
ar=$dest/archive$suffix

$dryrun mkdir -p $dest
$dryrun tar -C `dirname $dir` -cvzf $ar $EXCL $name
$dryrun touch $dest/.made
echo "Packed $dir to $ar"
