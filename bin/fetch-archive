#!/bin/bash

set -e

# Retrieve one archive file from the files server

if [ x$FILES_URL_PREFIX = x ]; then
    FILES_URL_PREFIX=http://files.opentreeoflife.org
fi

# command line arg = archive/ncbi-20170425

series=$1
name=$2

dryrun=
if [ x$DRYRUN != x ]; then dryrun=echo; fi

dir=r/$name

if [ -e $dir/archive/.made ]; then
    echo "$dir archive is already present"
    exit 0
fi

PROP_URL=$FILES_URL_PREFIX/$series/$name/properties.json

if [ x$dryrun = x ]; then
    wget -q --output-document=$dir/properties.json.new $PROP_URL
    mv $dir/properties.json.new $dir/properties.json
    suffix=`bin/get $name suffix`
else
    echo wget -q --output-document=$dir/properties.json $PROP_URL
    suffix=.suffix
fi

URL=$FILES_URL_PREFIX/$series/$name/$name$suffix

$dryrun mkdir -p $dir/archive

if $dryrun wget -q --output-document=$dir/archive/downloaded.tmp $URL; then

    # Finish up

    $dryrun mv -f $dir/archive/downloaded.tmp $dir/archive/archive$suffix
    $dryrun touch $dir/archive/.made
    $dryrun ls -l $dir/archive

else
    echo "wget of $URL failed"
    exit 1
fi


# Check it out
# N.b. $name could be foo-NEW

if [ ! -d r/$series-HEAD ]; then
    ln -sf $name r/$series-HEAD
else
    echo "Warning: r/$series-HEAD exists, so not directing it to $name"
fi
