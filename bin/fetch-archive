#!/bin/bash

set -e

# Retrieve one archive file from the files server

if [ x$FILES_URL_PREFIX = x ]; then
    FILES_URL_PREFIX=http://files.opentreeoflife.org
fi

# command line arg = archive/ncbi-20170425

name=$1
series=$2

dryrun=
if [ x$DRYRUN != x ]; then dryrun=echo; fi

dir=r/$name

if [ -e $dir/archive/.made ]; then
    echo "$dir archive is already present"
    exit 0
fi

$dryrun mkdir -p $dir

PROP_URL=$FILES_URL_PREFIX/$series/$name/properties.json

if [ x$dryrun = x ]; then
    if wget -q --output-document=$dir/properties.json.new $PROP_URL; then
        mv $dir/properties.json.new $dir/properties.json
    else
        echo "Failed to retrieve $PROP_URL"
        exit 1
    fi
    suffix=`bin/get $name suffix`
else
    echo wget -q --output-document=$dir/properties.json $PROP_URL
    suffix=.suffix
fi

URL=$FILES_URL_PREFIX/$series/$name/$name$suffix

$dryrun mkdir -p $dir/archive

echo Fetching $URL

if $dryrun wget -q --output-document=$dir/archive/downloaded.tmp $URL; then

    # Finish up

    $dryrun mv -f $dir/archive/downloaded.tmp $dir/archive/archive$suffix
    $dryrun touch $dir/archive/.made

else
    echo "wget of $URL failed"
    exit 1
fi
