#!/bin/bash

set -e

# Retrieve one archive file from the files server

if [ x$FILES_URL_PREFIX = x ]; then
    FILES_URL_PREFIX=http://files.opentreeoflife.org
fi

# command line arg = archive/ncbi-20170425

name=$1
dir=r/$name/archive

dryrun=
if [ x$DRYRUN != x ]; then dryrun=echo; fi

if [ -e $dir/.made ]; then
  echo "$dir is already present"
  exit 0
fi

series=`echo $name | egrep -o "^[^0-9.]+"`
# Index of last char in stem
i=$((${#series}-1))
if [ ${series:$i} = '-' ]; then
   series=${series:0:$i}
elif [ ${series:$i} = '.' ]; then
   series=${series:0:$i}
fi

PROP_URL=$FILES_URL_PREFIX/$series/$name/properties.json

if [ x$dryrun = x ]; then
    wget -q --output-document=$dir/properties.json.new $PROP_URL
    mv $dir/properties.json.new $dir/properties.json
    suffix=`bin/get $name suffix`
else
    echo wget -q --output-document=$dir/properties.json $PROP_URL
    suffix=.suffix
fi

URL=$FILES_URL_PREFIX/$series/$name/$name$suffix

$dryrun mkdir -p $dir

if $dryrun wget -q --output-document=$dir/downloaded.tmp $URL; then

    # Finish up

    $dryrun mv -f $dir/downloaded.tmp $dir/archive$suffix
    $dryrun touch $dir/.made
    $dryrun ls -l $dir

else
    echo "wget of $URL failed"
    exit 1
fi
